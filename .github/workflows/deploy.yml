name: Deploy Frontend

on:
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm install
      - run: npm run test

  deploy:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to DigitalOcean Droplet
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          script: |
            # Ensure PM2 is installed globally
            npm install -g pm2

            # Navigate to app directory
            cd /var/www/myaccounts-frontend
            
            # Pull latest changes
            git pull origin main
            
            # Install dependencies
            npm install
            
            # Create .env file from secrets for build time
            echo "VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL }}" > .env
            echo "VITE_GOOGLE_CLIENT_ID=${{ secrets.VITE_GOOGLE_CLIENT_ID }}" >> .env
            echo "VITE_APPLE_CLIENT_ID=${{ secrets.VITE_APPLE_CLIENT_ID }}" >> .env
            
           
            # Build the application (Vite builds to /dist)
            npm run build
            
            # Nginx serves the static files directly, so usually no restart needed.
            # However, we can reload config just to be safe/sure.
            # systemctl reload nginx
